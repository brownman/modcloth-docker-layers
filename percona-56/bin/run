#!/usr/bin/env bash

set -e

function main() {
  _initialize_db
  _massage_config
  _start_mysql_for_hooks
  _run_default_hooks
  _run_custom_hook_if_present
  _kill_background_mysql
  _exec_mysql "$@"
}

function _initialize_db(){
  if [[ ! -e /mysql/custom/init.done ]] ; then
    mysql_install_db --user=mysql \
      --basedir=/usr \
      --datadir=/mysql/db && \
      touch /mysql/custom/init.done
  fi
}

function _massage_config() {
  sed -i -e "s/SERVER_ID_PLACEHOLDER/$(printf '%d' 0x$(hostid))/" /mydql/db/my.cnf
}

function _start_mysql_for_hooks() {
    export MYSQL_UNIX_PORT=/mysql/db/mysql.sock
    /usr/sbin/mysqld \
      --user=mysql \
      --basedir=/usr \
      --datadir=/mysql/db \
      &
    export mysql_pid="$!"

    # wait for mysql to start
    while ! mysql >/dev/null 2>&1 ; do
      sleep 1
    done
}

function _run_default_hooks() {
  for script in 'default-first-run' 'start-replication' ; do
    if [[ ! -e /mysql/custom/"$script".done ]] ; then
      /mysql/bin/"$script" >> /mysql/custom/"$script".log 2>&1 && \
        touch /mysql/custom/"$script".done
    fi
  done
}

function _run_custom_hook_if_present() {
  if [[ ! -e /mysql/custom/first-run.done ]] && [[ -x /mysql/custom/first-run ]] ; then

    /mysql/custom/first-run >> /mysql/custom/first-run.log 2>&1 && \
      touch /mysql/custom/first-run.done
  fi
}

function _kill_background_mysql() {
    kill -15 "$mysql_pid"
}

function _exec_mysql() {
  export MYSQL_UNIX_PORT=/mysql/db/mysql.sock
  exec /usr/sbin/mysqld \
    --user=mysql \
    --basedir=/usr \
    --datadir=/mysql/db \
    "$@"
}

main "$@"
