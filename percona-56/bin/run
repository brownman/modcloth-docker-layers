#!/usr/bin/env bash

set -e

main() {
  initialize_db
  set_env
  write_config
  fix_permissions
  exec_mysql "$@"
}

initialize_db() {
  if [[ ! -e /mysql/hooks/init.done ]] ; then
    mysql_install_db --user=mysql \
      --basedir=/usr \
      --datadir=/mysql/db && \
      touch /mysql/hooks/init.done
  fi
}

set_env() {
  [[ -s /mysql/bin/env ]] && source /mysql/hooks/env
}

write_config() {
  ! ls /mysql/db/my.cnf 1>/dev/null 2>&1 || /mysql/bin/write-config
}

fix_permissions() {
  chown -R mysql:mysql /mysql
  chmod 640 /mysql/db/my.cnf
}

exec_mysql() {
  export MYSQL_UNIX_PORT=/mysql/db/mysql.sock
  /usr/sbin/mysqld \
    --user=mysql \
    --basedir=/usr \
    --datadir=/mysql/db \
    "$@" &
  export mysql_pid="$!"
  trap "kill -SIGQUIT $mysql_pid" INT
  wait $mysql_pid
}

main "$@"
